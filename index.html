<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bank PO Mock Test Tracker</title>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
<style>
  :root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --background: #f0f8ff;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--background);
    color: #333;
    line-height: 1.6;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }

  header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: var(--shadow);
  }

  h1 {
    color: var(--primary);
    margin-bottom: 10px;
  }

  .description {
    color: var(--secondary);
    max-width: 700px;
    margin: 0 auto;
  }

  .card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--dark);
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
  }

  button {
    background-color: var(--primary);
    border: none;
    color: white;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
    font-size: 16px;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  button i {
    margin-right: 8px;
  }

  button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
  }

  button.secondary {
    background-color: var(--secondary);
  }

  button.secondary:hover {
    background-color: #5a6268;
  }

  button.success {
    background-color: var(--success);
  }

  button.success:hover {
    background-color: #218838;
  }

  button.danger {
    background-color: var(--danger);
  }

  button.danger:hover {
    background-color: #c82333;
  }

  .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .search-container {
    display: flex;
    margin-bottom: 20px;
    gap: 10px;
  }

  .search-container input {
    flex: 1;
  }

  .filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }

  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  th,
  td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  th {
    background-color: var(--primary);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.02);
  }

  tr:hover {
    background-color: rgba(67, 97, 238, 0.05);
  }

  .action-cell {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 5px 10px;
    font-size: 14px;
  }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .summary-card h3 {
    margin-bottom: 10px;
    color: var(--secondary);
    font-size: 16px;
  }

  .summary-card p {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
  }

  .chart-container {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background: #f1f1f1;
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 5px 5px 0 0;
    margin-right: 5px;
  }

  .tab.active {
    background: var(--card-bg);
    border-bottom: 1px solid var(--card-bg);
    margin-bottom: -1px;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--secondary);
  }

  .empty-state i {
    font-size: 50px;
    margin-bottom: 15px;
    color: #ccc;
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bank PO Mock Test Tracker</h1>
      <p class="description">
        Track your mock test scores, analyze your performance, and identify
        areas for improvement.
      </p>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Add New Test Result</h2>
        <form id="mockTestForm">
          <input type="hidden" id="editIndex" value="-1" />

          <div class="form-group">
            <label for="examName">Exam Name</label>
            <input
              type="text"
              id="examName"
              name="examName"
              required
              placeholder="e.g., SBI PO, IBPS PO"
            />
          </div>

          <div class="form-group">
            <label for="testType">Test Type</label>
            <select id="testType" name="testType" required>
              <option value="full-length">Full-Length</option>
              <option value="prelims-sectional">Prelims Sectional</option>
              <option value="mains-sectional">Mains Sectional</option>
            </select>
          </div>

          <div class="form-group" id="sectionGroup" style="display: none;">
            <label for="section">Section</label>
            <select id="section" name="section">
              <option value="" disabled selected>
                Select Section
              </option>
              <option value="Quantitative">Quantitative</option>
              <option value="Reasoning">Reasoning</option>
              <option value="English">English</option>
              <option value="Current Affairs">Current Affairs</option>
            </select>
          </div>

          <div class="form-group" id="quantGroup">
            <label for="quantScore">Quantitative Score</label>
            <input type="number" id="quantScore" name="quantScore" min="0" />
          </div>

          <div class="form-group" id="reasoningGroup">
            <label for="reasoningScore">Reasoning Score</label>
            <input type="number" id="reasoningScore" name="reasoningScore" min="0" />
          </div>

          <div class="form-group" id="englishGroup">
            <label for="englishScore">English Score</label>
            <input type="number" id="englishScore" name="englishScore" min="0" />
          </div>

          <div class="form-group" id="currentGroup">
            <label for="currentAffairsScore">Current Affairs Score</label>
            <input
              type="number"
              id="currentAffairsScore"
              name="currentAffairsScore"
              min="0"
            />
          </div>

          <div class="form-group">
            <label for="platform">Test Platform</label>
            <input
              type="text"
              id="platform"
              name="platform"
              required
              placeholder="e.g., Testbook, Guidely"
            />
          </div>

          <div class="form-group">
            <label for="date">Test Date</label>
            <input type="date" id="date" name="date" required />
          </div>

          <div class="form-group">
            <label for="totalScore">Total Score</label>
            <input type="number" id="totalScore" name="totalScore" min="0" required />
          </div>

          <div class="form-group">
            <label for="percentile">Percentile</label>
            <input
              type="number"
              id="percentile"
              name="percentile"
              min="0"
              max="100"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label for="accuracy">Accuracy (%)</label>
            <input
              type="number"
              id="accuracy"
              name="accuracy"
              min="0"
              max="100"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label for="timeSpent">Time Spent (minutes)</label>
            <input
              type="number"
              id="timeSpent"
              name="timeSpent"
              min="0"
              step="1"
              placeholder="Optional"
            />
          </div>

          <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea
              id="notes"
              name="notes"
              rows="3"
              placeholder="Any additional notes about this test..."
            ></textarea>
          </div>

          <div class="action-buttons">
            <button type="submit" id="submitBtn" class="success">
              <i class="fas fa-save"></i> Save Test
            </button>
            <button
              type="button"
              id="cancelEditBtn"
              class="secondary"
              style="display: none"
            >
              <i class="fas fa-times"></i> Cancel Edit
            </button>
            <button type="reset" class="secondary">
              <i class="fas fa-undo"></i> Reset Form
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Performance Summary</h2>
        <div class="summary-cards">
          <div class="summary-card">
            <h3>Average Total Score</h3>
            <p id="avgTotal">N/A</p>
          </div>
          <div class="summary-card">
            <h3>Average Quant Score</h3>
            <p id="avgQuant">N/A</p>
          </div>
          <div class="summary-card">
            <h3>Average Reasoning Score</h3>
            <p id="avgReasoning">N/A</p>
          </div>
          <div class="summary-card">
            <h3>Average English Score</h3>
            <p id="avgEnglish">N/A</p>
          </div>
        </div>

        <div class="summary-cards">
          <div class="summary-card">
            <h3>Best Total Score</h3>
            <p id="bestTotal">N/A</p>
          </div>
          <div class="summary-card">
            <h3>Tests Taken</h3>
            <p id="testsCount">0</p>
          </div>
          <div class="summary-card">
            <h3>Average Accuracy</h3>
            <p id="avgAccuracy">N/A</p>
          </div>
          <div class="summary-card">
            <h3>Average Percentile</h3>
            <p id="avgPercentile">N/A</p>
          </div>
        </div>
      </div>
    </div>

    <div class="goal-container">
      <div class="goal-header">
        <h2>Progress Towards Goal</h2>
        <button type="button" id="setGoalBtn" class="secondary">
          <i class="fas fa-bullseye"></i> Set Goal
        </button>
      </div>
      <div class="goal-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="goalProgressBar" style="width: 0%"></div>
        </div>
        <div class="goal-stats">
          <span id="currentScore">Current: N/A</span>
          <span id="goalText">Goal: Not Set</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Test History</h2>

      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Search by platform, notes, exam name, type, section..."
        />
        <button type="button" id="clearSearchBtn" class="secondary">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>

      <div class="filters">
        <div class="filter-item">
          <label for="dateFrom">From Date</label>
          <input type="date" id="dateFrom" />
        </div>
        <div class="filter-item">
          <label for="dateTo">To Date</label>
          <input type="date" id="dateTo" />
        </div>
        <div class="filter-item">
          <label for="platformFilter">Platform</label>
          <select id="platformFilter">
            <option value="">All Platforms</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="sortBy">Sort By</label>
          <select id="sortBy">
            <option value="date">Date (Oldest First)</option>
            <option value="date-desc">Date (Newest First)</option>
            <option value="totalScore">Total Score (Lowest First)</option>
            <option value="totalScore-desc">Total Score (Highest First)</option>
            <option value="platform">Platform (A-Z)</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table id="testsTable">
          <thead>
            <tr>
              <th>Exam Name</th>
              <th>Test Type</th>
              <th>Section</th>
              <th>Platform</th>
              <th>Date</th>
              <th>Total Score</th>
              <th>Quant</th>
              <th>Reasoning</th>
              <th>English</th>
              <th>Percentile</th>
              <th>Accuracy</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>

      <div id="emptyState" class="empty-state" style="display: none">
        <i class="fas fa-clipboard-list"></i>
        <h3>No test records found</h3>
        <p>Add your first test result to get started!</p>
      </div>

      <div class="export-options">
        <button type="button" id="exportCSVBtn" class="secondary">
          <i class="fas fa-file-csv"></i> Export to CSV
        </button>
        <button type="button" id="exportJSONBtn" class="secondary">
          <i class="fas fa-file-code"></i> Export to JSON
        </button>
        <button type="button" id="importBtn" class="secondary">
          <i class="fas fa-file-import"></i> Import Data
        </button>
        <button type="button" id="clearAllBtn" class="danger">
          <i class="fas fa-trash"></i> Clear All Data
        </button>
      </div>
    </div>

    <div class="card">
      <h2>Performance Analytics</h2>

      <div class="tabs">
        <div class="tab active" data-tab="scores">Scores</div>
        <div class="tab" data-tab="section-wise">Section Wise</div>
        <div class="tab" data-tab="accuracy">Accuracy & Percentile</div>
        <div class="tab" data-tab="time">Time Management</div>
      </div>

      <div class="tab-content active" id="scores-tab">
        <div class="chart-container">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>

      <div class="tab-content" id="section-wise-tab">
        <div class="chart-container">
          <canvas id="sectionChart"></canvas>
        </div>
      </div>

      <div class="tab-content" id="accuracy-tab">
        <div class="chart-container">
          <canvas id="accuracyChart"></canvas>
        </div>
      </div>

      <div class="tab-content" id="time-tab">
        <div class="chart-container">
          <canvas id="timeChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importFile" accept=".json,.csv" style="display: none" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script>
    // DOM Elements
    const form = document.getElementById("mockTestForm");
    const tableBody = document.querySelector("#testsTable tbody");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const platformFilter = document.getElementById("platformFilter");
    const sortBy = document.getElementById("sortBy");
    const exportCSVBtn = document.getElementById("exportCSVBtn");
    const exportJSONBtn = document.getElementById("exportJSONBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const submitBtn = document.getElementById("submitBtn");
    const emptyState = document.getElementById("emptyState");
    const tabs = document.querySelectorAll(".tab");
    const tabContents = document.querySelectorAll(".tab-content");
    const setGoalBtn = document.getElementById("setGoalBtn");
    const goalProgressBar = document.getElementById("goalProgressBar");
    const currentScore = document.getElementById("currentScore");
    const goalText = document.getElementById("goalText");
    const testTypeSelect = document.getElementById("testType");
    const sectionGroup = document.getElementById("sectionGroup");
    const sectionSelect = document.getElementById("section");
    const quantGroup = document.getElementById("quantGroup");
    const reasoningGroup = document.getElementById("reasoningGroup");
    const englishGroup = document.getElementById("englishGroup");
    const currentGroup = document.getElementById("currentGroup");

    const sectionGroups = {
      Quantitative: quantGroup,
      Reasoning: reasoningGroup,
      English: englishGroup,
      "Current Affairs": currentGroup,
    };

    // Score inputs map to their inputs
    const scoreInputs = {
      Quantitative: quantGroup.querySelector("input"),
      Reasoning: reasoningGroup.querySelector("input"),
      English: englishGroup.querySelector("input"),
      "Current Affairs": currentGroup.querySelector("input"),
    };

    // Test data storage
    let tests = JSON.parse(localStorage.getItem("mockTests")) || [];
    let scoreGoal = JSON.parse(localStorage.getItem("scoreGoal")) || null;
    let scoreChart, sectionChart, accuracyChart, timeChart;

    // Initialize app
    function init() {
      renderTests();
      updatePlatformFilter();
      setupEventListeners();
      setDefaultDate();
      updateGoalProgress();
      updateVisibleScores();
    }

    // Default date today
    function setDefaultDate() {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("date").value = today;
    }

    // Hide/show score fields based on test type and section chosen
    function updateVisibleScores() {
      if (testTypeSelect.value === "full-length") {
        sectionGroup.style.display = "none";
        Object.values(sectionGroups).forEach((group) => {
          group.style.display = "block";
          group.querySelector("input").required = true;
        });
      } else {
        sectionGroup.style.display = "block";
        Object.values(sectionGroups).forEach((group) => {
          group.style.display = "none";
          group.querySelector("input").required = false;
          group.querySelector("input").value = "";
        });
        if (
          sectionSelect.value &&
          sectionGroups.hasOwnProperty(sectionSelect.value)
        ) {
          const selectedGroup = sectionGroups[sectionSelect.value];
          selectedGroup.style.display = "block";
          selectedGroup.querySelector("input").required = true;
        }
      }
    }

    // Setup event listeners for form and filters
    function setupEventListeners() {
      form.addEventListener("submit", saveTest);
      searchInput.addEventListener("input", renderTests);
      clearSearchBtn.addEventListener("click", () => {
        searchInput.value = "";
        renderTests();
      });
      dateFrom.addEventListener("change", renderTests);
      dateTo.addEventListener("change", renderTests);
      platformFilter.addEventListener("change", renderTests);
      sortBy.addEventListener("change", renderTests);
      exportCSVBtn.addEventListener("click", exportToCSV);
      exportJSONBtn.addEventListener("click", exportToJSON);
      importBtn.addEventListener("click", () => importFile.click());
      importFile.addEventListener("change", importData);
      clearAllBtn.addEventListener("click", clearAllData);
      cancelEditBtn.addEventListener("click", cancelEdit);
      setGoalBtn.addEventListener("click", setScoreGoal);
      testTypeSelect.addEventListener("change", () => {
        sectionSelect.value = "";
        updateVisibleScores();
      });
      sectionSelect.addEventListener("change", updateVisibleScores);

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const tabId = tab.getAttribute("data-tab");
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          tabContents.forEach((content) => {
            if (content.id === `${tabId}-tab`) content.classList.add("active");
            else content.classList.remove("active");
          });

          if (tabId === "section-wise" && tests.length > 0)
            renderSectionChart(getFilteredTests());
          else if (tabId === "accuracy" && tests.length > 0)
            renderAccuracyChart(getFilteredTests());
          else if (tabId === "time" && tests.length > 0)
            renderTimeChart(getFilteredTests());
        });
      });
    }

    // Filter tests based on search and filters
    function getFilteredTests() {
      let filteredTests = [...tests];
      const searchTerm = searchInput.value.toLowerCase();

      if (searchTerm) {
        filteredTests = filteredTests.filter(
          (t) =>
            (t.platform && t.platform.toLowerCase().includes(searchTerm)) ||
            (t.notes && t.notes.toLowerCase().includes(searchTerm)) ||
            (t.examName && t.examName.toLowerCase().includes(searchTerm)) ||
            (t.testType && t.testType.toLowerCase().includes(searchTerm)) ||
            (t.section && t.section.toLowerCase().includes(searchTerm))
        );
      }
      if (dateFrom.value) {
        filteredTests = filteredTests.filter((t) => t.date >= dateFrom.value);
      }
      if (dateTo.value) {
        filteredTests = filteredTests.filter((t) => t.date <= dateTo.value);
      }
      if (platformFilter.value) {
        filteredTests = filteredTests.filter(
          (t) => t.platform === platformFilter.value
        );
      }

      switch (sortBy.value) {
        case "date":
          filteredTests.sort(
            (a, b) => new Date(a.date) - new Date(b.date)
          );
          break;
        case "date-desc":
          filteredTests.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );
          break;
        case "totalScore":
          filteredTests.sort((a, b) => a.totalScore - b.totalScore);
          break;
        case "totalScore-desc":
          filteredTests.sort((a, b) => b.totalScore - a.totalScore);
          break;
        case "platform":
          filteredTests.sort((a, b) => a.platform.localeCompare(b.platform));
          break;
      }
      return filteredTests;
    }

    // Render test table rows
    function renderTests() {
      const filteredTests = getFilteredTests();
      tableBody.innerHTML = "";

      if (filteredTests.length === 0) {
        emptyState.style.display = "block";
        return;
      } else {
        emptyState.style.display = "none";
      }

      filteredTests.forEach((test, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${test.examName || ""}</td>
          <td>${getTestTypeLabel(test.testType)}</td>
          <td>${test.section || "-"}</td>
          <td>${test.platform}</td>
          <td>${formatDate(test.date)}</td>
          <td>${test.totalScore}</td>
          <td>${nullableScore(test.quantScore)}</td>
          <td>${nullableScore(test.reasoningScore)}</td>
          <td>${nullableScore(test.englishScore)}</td>
          <td>${nullableScore(test.currentAffairsScore)}</td>      
          <td>${test.percentile}%</td>
          <td>${test.accuracy}%</td>
          <td class="action-cell">
            <button class="action-btn secondary" onclick="editTest(${index})"><i class="fas fa-edit"></i></button>
            <button class="action-btn danger" onclick="deleteTest(${index})"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      updateSummary(filteredTests);
      renderScoreChart(filteredTests);
      updateGoalProgress();
    }

    // Helper to show dash for null scores
    function nullableScore(score) {
      return score === null || score === undefined || isNaN(score) ? "-" : score;
    }

    // Map testType codes to labels
    function getTestTypeLabel(type) {
      switch (type) {
        case "full-length":
          return "Full-Length";
        case "prelims-sectional":
          return "Prelims Sectional";
        case "mains-sectional":
          return "Mains Sectional";
        default:
          return type || "-";
      }
    }

    // Date formatting
    function formatDate(dt) {
      const options = { year: "numeric", month: "short", day: "numeric" };
      return new Date(dt).toLocaleDateString(undefined, options);
    }

    // Update platform filter dropdown
    function updatePlatformFilter() {
      const platforms = [...new Set(tests.map((t) => t.platform))].sort();
      while (platformFilter.options.length > 1) platformFilter.remove(1);
      platforms.forEach((platform) => {
        const option = document.createElement("option");
        option.value = platform;
        option.textContent = platform;
        platformFilter.appendChild(option);
      });
    }

    // Update summary cards
    function updateSummary(data) {
      const testsCount = document.getElementById("testsCount");
      testsCount.textContent = data.length;

      if (data.length === 0) {
        [
          "avgTotal",
          "avgQuant",
          "avgReasoning",
          "avgEnglish",
          "bestTotal",
          "avgAccuracy",
          "avgPercentile",
        ].forEach((id) => (document.getElementById(id).textContent = "N/A"));
        return;
      }

      const avg = (field) => {
        const vals = data
          .map((t) => t[field])
          .filter((v) => v !== null && v !== undefined && !isNaN(v));
        if (vals.length === 0) return "N/A";
        return (vals.reduce((acc, v) => acc + v, 0) / vals.length).toFixed(2);
      };

      document.getElementById("avgTotal").textContent = avg("totalScore");
      document.getElementById("avgQuant").textContent = avg("quantScore");
      document.getElementById("avgReasoning").textContent = avg("reasoningScore");
      document.getElementById("avgEnglish").textContent = avg("englishScore");
      document.getElementById("bestTotal").textContent = Math.max(
        ...data.map((t) => t.totalScore)
      );
      document.getElementById("avgAccuracy").textContent =
        avg("accuracy") !== "N/A" ? avg("accuracy") + "%" : "N/A";
      document.getElementById("avgPercentile").textContent =
        avg("percentile") !== "N/A" ? avg("percentile") + "%" : "N/A";
    }

    // Update progress bar for goal
    function updateGoalProgress() {
      if (!scoreGoal || tests.length === 0) {
        goalProgressBar.style.width = "0%";
        currentScore.textContent = "Current: N/A";
        goalText.textContent = "Goal: Not Set";
        return;
      }
      const latestTest = tests.reduce(
        (latest, test) =>
          new Date(test.date) > new Date(latest.date) ? test : latest,
        tests[0]
      );
      const progress = Math.min(
        100,
        (latestTest.totalScore / scoreGoal) * 100
      );
      goalProgressBar.style.width = `${progress}%`;
      currentScore.textContent = `Current: ${latestTest.totalScore}`;
      goalText.textContent = `Goal: ${scoreGoal}`;
    }

    // Set target score goal
    function setScoreGoal() {
      const goal = prompt("Set your target total score:");
      if (goal !== null) {
        if (!isNaN(goal) && goal > 0) {
          scoreGoal = parseInt(goal);
          localStorage.setItem("scoreGoal", JSON.stringify(scoreGoal));
          updateGoalProgress();
        } else {
          alert("Please enter a valid positive number for your goal.");
        }
      }
    }

    // Save or update test record
    function saveTest(e) {
      e.preventDefault();

      if (!form.examName.value.trim()) {
        alert("Please enter Exam Name.");
        form.examName.focus();
        return;
      }
      if (!form.platform.value.trim()) {
        alert("Please enter Test Platform.");
        form.platform.focus();
        return;
      }
      if (!form.date.value) {
        alert("Please enter Test Date.");
        form.date.focus();
        return;
      }
      if (!form.totalScore.value || form.totalScore.value < 0) {
        alert("Please enter a valid Total Score.");
        form.totalScore.focus();
        return;
      }
      if (!form.percentile.value || form.percentile.value < 0) {
        alert("Please enter a valid Percentile between 0 and 100.");
        form.percentile.focus();
        return;
      }
      if (!form.accuracy.value || form.accuracy.value < 0) {
        alert("Please enter a valid Accuracy between 0 and 100.");
        form.accuracy.focus();
        return;
      }

      if (
        form.testType.value === "prelims-sectional" ||
        form.testType.value === "mains-sectional"
      ) {
        if (!form.section.value) {
          alert("Please select a Section for sectional test.");
          form.section.focus();
          return;
        }
        const section = form.section.value;
        const scoreFieldId = {
          Quantitative: "quantScore",
          Reasoning: "reasoningScore",
          English: "englishScore",
          "Current Affairs": "currentAffairsScore",
        }[section];

        if (!form[scoreFieldId].value || form[scoreFieldId].value < 0) {
          alert(`Please enter a valid score for ${section}.`);
          form[scoreFieldId].focus();
          return;
        }
      } else {
        ["quantScore", "reasoningScore", "englishScore", "currentAffairsScore"].forEach(
          (id) => {
            if (!form[id].value || form[id].value < 0) {
              alert(`Please enter a valid score for ${id.replace("Score", "")}.`);
              form[id].focus();
              throw "ValidationError";
            }
          }
        );
      }

      const getNumberOrNull = (val) =>
        val === "" || val === null ? null : Number(val);

      const newTest = {
        examName: form.examName.value.trim(),
        testType: form.testType.value,
        section:
          form.testType.value === "full-length" ? null : form.section.value,
        platform: form.platform.value.trim(),
        date: form.date.value,
        totalScore: Number(form.totalScore.value),
        quantScore: getNumberOrNull(form.quantScore.value),
        reasoningScore: getNumberOrNull(form.reasoningScore.value),
        englishScore: getNumberOrNull(form.englishScore.value),
        currentAffairsScore: getNumberOrNull(form.currentAffairsScore.value),
        percentile: Number(form.percentile.value),
        accuracy: Number(form.accuracy.value),
        timeSpent: form.timeSpent.value ? Number(form.timeSpent.value) : null,
        notes: form.notes.value.trim(),
      };

      const editIndex = parseInt(form.editIndex.value);
      if (editIndex >= 0) {
        tests[editIndex] = newTest;
        cancelEdit();
      } else {
        tests.push(newTest);
      }
      localStorage.setItem("mockTests", JSON.stringify(tests));
      form.reset();
      setDefaultDate();
      updateVisibleScores();
      renderTests();
      updatePlatformFilter();
    }

    // Edit test record
    function editTest(index) {
      const test = tests[index];
      form.examName.value = test.examName || "";
      form.testType.value = test.testType || "full-length";
      updateVisibleScores();
      form.section.value = test.section || "";
      form.platform.value = test.platform || "";
      form.date.value = test.date || "";
      form.totalScore.value = test.totalScore || "";
      form.quantScore.value = test.quantScore ?? "";
      form.reasoningScore.value = test.reasoningScore ?? "";
      form.englishScore.value = test.englishScore ?? "";
      form.currentAffairsScore.value = test.currentAffairsScore ?? "";
      form.percentile.value = test.percentile || "";
      form.accuracy.value = test.accuracy || "";
      form.timeSpent.value = test.timeSpent ?? "";
      form.notes.value = test.notes || "";
      form.editIndex.value = index;
      submitBtn.innerHTML = '<i class="fas fa-edit"></i> Update Test';
      cancelEditBtn.style.display = "inline-flex";
      form.scrollIntoView({ behavior: "smooth" });
    }

    // Cancel edit mode
    function cancelEdit() {
      form.reset();
      setDefaultDate();
      form.editIndex.value = "-1";
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Test';
      cancelEditBtn.style.display = "none";
      updateVisibleScores();
    }

    // Delete test record
    function deleteTest(index) {
      if (confirm("Are you sure you want to delete this test record?")) {
        tests.splice(index, 1);
        localStorage.setItem("mockTests", JSON.stringify(tests));
        renderTests();
        updatePlatformFilter();
      }
    }

    // Export and import functions
    function exportToCSV() {
      if (tests.length === 0) {
        alert("No data to export!");
        return;
      }
      const csv = Papa.unparse(tests);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const date = new Date().toISOString().split("T")[0];
      link.setAttribute("href", url);
      link.setAttribute("download", `bankpo_mock_tests_${date}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportToJSON() {
      if (tests.length === 0) {
        alert("No data to export!");
        return;
      }
      const dataStr = JSON.stringify(tests, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const date = new Date().toISOString().split("T")[0];
      link.setAttribute("href", url);
      link.setAttribute("download", `bankpo_mock_tests_${date}.json`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          let importedData;
          if (file.name.endsWith(".json")) {
            importedData = JSON.parse(e.target.result);
          } else if (file.name.endsWith(".csv")) {
            const results = Papa.parse(e.target.result, {
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
            });
            importedData = results.data;
          } else {
            throw new Error("Unsupported file format");
          }
          if (!Array.isArray(importedData))
            throw new Error("Invalid data format");
          // validation of required fields
          const requiredFields = [
            "examName",
            "testType",
            "platform",
            "date",
            "totalScore",
            "percentile",
            "accuracy",
          ];
          const valid = importedData.every((item) =>
            requiredFields.every((field) => field in item)
          );
          if (!valid) throw new Error("Imported data missing required fields");
          if (
            confirm(
              `Import ${importedData.length} test records? This will replace your current data.`
            )
          ) {
            tests = importedData;
            localStorage.setItem("mockTests", JSON.stringify(tests));
            renderTests();
            updatePlatformFilter();
            alert("Data imported successfully!");
          }
        } catch (error) {
          alert("Error importing data: " + error.message);
          console.error(error);
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    }

    function clearAllData() {
      if (tests.length === 0) {
        alert("No data to clear!");
        return;
      }
      if (confirm("Are you sure you want to delete ALL test records? This cannot be undone.")) {
        tests = [];
        localStorage.removeItem("mockTests");
        renderTests();
        updatePlatformFilter();
      }
    }

    // Initialize the app
    init();
  </script>
</body>
</html>
